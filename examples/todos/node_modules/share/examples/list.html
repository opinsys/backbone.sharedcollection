<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <style>
#trains { list-style-type: none; margin: 0; padding: 0; width: 20em; }
#trains li {
 margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1.4em; height: 18px;
border: 1px solid #CCC;
outline: none;
}
    </style>

  </head>
  <body>
  <div>
<ul id="trains">
</ul>
</div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
  <script src="/lib/jquery.quicksand.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/share/share.js"></script>
  <script src="/share/json.js"></script>

  <script>
$(function() {
  sharejs.open('thomas', 'json', function(error, doc) {
    if (error) {
      if (console) {
        console.error(error);
      }
      return;
    }
    
    if (doc.created) {
      doc.set(["Thomas the Tank Engine",
        "Edward the Blue Engine",
        "Henry the Green Engine",
        "Gordon the Big Engine",
        "James the Red Engine",
        "Percy the Small Engine",
        "The Fat Controller"
      ]);
    }
    
    var trains = doc.get();
    $.each(trains, function(i, train) {
      $('#trains').append($('<li>').text(trains[i])); //.attr('data-id', i)
    });

    var dragFrom = null;
    
    doc.at().on('move', function(from, to) {
      console.log('move', from, to);
      if (dragFrom === from) {
        dragFrom = to;
      } else {
        console.log('#trains :nth-child(' + (from + 1) + ')');
        console.log($('#trains :nth-child(' + 1 + ')'));
        console.log($('#trains :nth-child(' + 2 + ')'));

        if (to === 0) {
          $('#trains :nth-child(' + (from + 1) + ')')
            .remove()
            .insertBefore($('#trains :nth-child(' + (to + 1) + ')'));
        } else {
          $('#trains :nth-child(' + (from + 1) + ')')
            .remove()
            .insertAfter($('#trains :nth-child(' + to + ')'));
        }
      }
    });    
    
    $("#trains").sortable({
      helper: 'clone',
      start: function(event, ui) {
        dragFrom = ui.item.index();
        ui.item.remove();
//        console.log('start', ui.item.index());
      },
      update: function(event, ui) {
        //console.log('update', ui.item.index());
        dragFrom = null;
      },
      change: function(event, ui) {
        var newPos = ui.placeholder.index();
        console.log('sending move', dragFrom, newPos);
        doc.at().move(dragFrom, newPos);
        dragFrom = newPos;
//        console.log('change', ui.item.index(), ui.placeholder.index(), ui);
      },
      beforeStop: function(event, ui) {
        //console.log(ui.item);
        ui.placeholder.before(ui.item);
      },
      //    revert: true,
      axis: 'y'
    });
//    $("#trains").disableSelection();

  });
});
  </script>

</body>
</html>
